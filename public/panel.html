<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eps1llon Seller Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        :root {
            --font-family: 'Inter', sans-serif;
            --background-primary: #0d1117;
            --background-secondary: #161b22;
            --surface-primary: #21262d;
            --surface-hover: #30363d;
            --border-primary: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #7d8590;
            --text-emphasis: #f0f6fc;
            --accent-primary: #2f81f7;
            --accent-primary-hover: #58a6ff;
            --accent-danger: #da3633;
            --accent-danger-hover: #f85149;
            --accent-success: #238636;
            --accent-success-hover: #2ea043;
            --accent-warning: #d29922;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            --radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-family: var(--font-family); background: var(--background-primary); color: var(--text-primary); font-size: 14px; }
        body { height: 100vh; width: 100vw; overflow: hidden; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Login Screen */
        #login-container { display: flex; align-items: center; justify-content: center; height: 100%; animation: fadeIn 0.5s ease; }
        .login-box { width: 100%; max-width: 400px; padding: 2.5rem; background: var(--background-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); }
        .login-box.shake { animation: shake 0.4s ease-in-out; }
        .login-box h2 { display: flex; align-items: center; justify-content: center; gap: 0.75rem; font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-emphasis); }
        .login-box h2 i { color: var(--accent-primary); }
        .login-box p { color: var(--text-secondary); margin-bottom: 2rem; }
        #login-error { color: var(--accent-danger); font-size: 0.9rem; margin-top: 1rem; min-height: 1.2em; }

        /* Main App Layout */
        #app-container { display: none; grid-template-columns: 240px 1fr; height: 100vh; width: 100vw; }
        #app-container.chat-open { grid-template-columns: 240px 380px 1fr 300px; }
        
        .sidebar { background: var(--background-primary); border-right: 1px solid var(--border-primary); display: flex; flex-direction: column; padding: 1rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; margin-bottom: 1.5rem;}
        .logo i { font-size: 1.75rem; color: var(--accent-primary); }
        .logo h1 { font-size: 1.25rem; font-weight: 600; }
        .nav-links { flex-grow: 1; }
        .nav-links a { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; margin-bottom: 0.25rem; font-size: 1rem; font-weight: 500; color: var(--text-secondary); text-decoration: none; border-radius: 6px; transition: color 0.2s ease, background-color 0.2s ease; }
        .nav-links a:hover { color: var(--text-emphasis); background: var(--surface-hover); }
        .nav-links a.active { color: var(--text-emphasis); background: var(--accent-primary); font-weight: 600; }
        .nav-links a i { width: 20px; text-align: center; }

        /* Main Content Panel */
        .main-content { display: flex; flex-direction: column; background: var(--background-secondary); overflow: hidden; }
        
        /* Ticket List Panel */
        .ticket-list-panel { display: flex; flex-direction: column; height: 100%; border-right: 1px solid var(--border-primary); background: var(--background-secondary); }
        .ticket-list-header { padding: 1rem; border-bottom: 1px solid var(--border-primary); flex-shrink: 0; }
        .ticket-list-header h1 { font-size: 1.25rem; margin-bottom: 1rem; }
        .ticket-filters { display: flex; gap: 0.5rem; }
        .search-wrapper { position: relative; flex-grow: 1; }
        .search-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        #search-input { padding-left: 36px; }
        
        #ticket-list-container { overflow-y: auto; flex-grow: 1; }
        .ticket-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-primary); cursor: pointer; position: relative; transition: background-color 0.2s ease; }
        .ticket-item:hover { background-color: var(--surface-primary); }
        .ticket-item.active { background-color: var(--accent-primary); color: white; }
        .ticket-item.active .ticket-timestamp, .ticket-item.active .ticket-payment { color: rgba(255,255,255,0.8); }
        
        .ticket-status { width: 4px; height: 40px; border-radius: 4px; flex-shrink: 0; }
        .ticket-status.awaiting { background-color: var(--accent-warning); }
        .ticket-status.active { background-color: var(--accent-success); }
        .ticket-status.completed { background-color: var(--text-secondary); }

        .ticket-details { flex-grow: 1; min-width: 0; }
        .ticket-details-row1 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .ticket-buyer { font-weight: 600; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        .ticket-timestamp { font-size: 0.8rem; color: var(--text-secondary); }
        .ticket-payment { font-size: 0.85rem; color: var(--text-secondary); }

        .ticket-actions { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); display: flex; gap: 0.5rem; background-color: var(--surface-primary); padding: 4px; border-radius: 6px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .ticket-item:hover .ticket-actions { opacity: 1; pointer-events: all; }
        .action-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px; border-radius: 4px; width: 28px; height: 28px; display: grid; place-items: center; }
        .action-btn:hover { color: var(--text-primary); background-color: var(--surface-hover); }

        /* Chat Panel */
        .chat-panel { display: flex; flex-direction: column; height: 100%; background: var(--background-secondary); }
        .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-primary); flex-shrink: 0; }
        .chat-header h2 { font-size: 1.1rem; }
        
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column-reverse; }
        .message-list-wrapper { display: flex; flex-direction: column; gap: 1rem; }
        .message-bubble { max-width: 75%; padding: 0.75rem 1.25rem; line-height: 1.5; border-radius: 18px; animation: slideInUp 0.3s ease-out; word-wrap: break-word; }
        .message-bubble.seller { background: var(--accent-primary); color: white; border-bottom-right-radius: 6px; align-self: flex-end; }
        .message-bubble.user { background: var(--background-primary); border: 1px solid var(--border-primary); border-bottom-left-radius: 6px; align-self: flex-start; }

        .chat-reply-form { display: flex; gap: 1rem; align-items: flex-start; padding: 1rem; border-top: 1px solid var(--border-primary); background: var(--background-primary); }
        
        /* Buyer Details Panel */
        .details-panel { padding: 1.5rem 1rem; background: var(--background-primary); border-left: 1px solid var(--border-primary); }
        .details-panel h3 { font-size: 1.2rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-primary); padding-bottom: 0.75rem; }
        .detail-item { margin-bottom: 1.25rem; }
        .detail-item label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .detail-item p { font-size: 1rem; }

        /* General UI elements */
        .placeholder { display: flex; flex-direction: column; height: 100%; justify-content: center; align-items: center; color: var(--text-secondary); text-align: center; }
        .placeholder i { font-size: 3rem; margin-bottom: 1rem; }
        
        .form-control { width: 100%; padding: 0.75rem 1rem; background: var(--background-primary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 6px; font-size: 1rem; transition: 0.2s ease; }
        .form-control:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.3); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: 500; font-size: 1rem; padding: 0.6rem 1rem; border-radius: 6px; border: 1px solid transparent; text-decoration: none; cursor: pointer; transition: 0.2s ease; }
        .btn-primary { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }
        .btn-primary:hover:not(:disabled) { background: var(--accent-primary-hover); border-color: var(--accent-primary-hover); }
        .btn-secondary { background: var(--surface-primary); color: var(--text-primary); border-color: var(--border-primary); }
        .btn-secondary:hover:not(:disabled) { background: var(--surface-hover); }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1001; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { display: flex; align-items: center; gap: 0.75rem; background: var(--surface-primary); color: var(--text-emphasis); padding: 0.75rem 1.25rem; border-radius: 6px; box-shadow: var(--shadow); border-left: 4px solid var(--accent-primary); animation: slideInUp 0.4s ease-out; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <audio id="notification-sound" src="http://sndup.net/hb96h" preload="auto"></audio>
    
    <div id="login-container">
        <div class="login-box">
            <h2><i class="fa-solid fa-atom"></i> Eps1llon Seller Hub</h2>
            <p>Please log in to your seller account.</p>
            <form id="login-form">
                <div class="input-group" style="margin-bottom: 1.25rem;">
                    <input type="text" id="username" class="form-control" placeholder="Username" required>
                </div>
                <div class="input-group" style="margin-bottom: 1.25rem;">
                    <input type="password" id="password" class="form-control" placeholder="Password" required>
                </div>
                <div class="cf-turnstile" data-sitekey="0x4AAAAAAB0PeEmSeY6uJ3nN" data-theme="dark" style="margin-bottom: 1.5rem;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 0.75rem;">Login</button>
                <p id="login-error">&nbsp;</p>
            </form>
        </div>
    </div>

    <div id="app-container">
        <aside class="sidebar">
            <div class="logo">
                <i class="fa-solid fa-atom"></i>
                <h1>Eps1llon</h1>
            </div>
            <nav class="nav-links">
                <a href="#" class="active"><i class="fas fa-inbox fa-fw"></i> <span>Inbox</span></a>
            </nav>
            <div style="flex-grow: 1;"></div>
            <a href="#" id="logout-btn" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </a>
        </aside>

        <div class="ticket-list-panel" id="ticket-list-panel">
            <div class="ticket-list-header">
                <h1>All Tickets</h1>
                <div class="ticket-filters">
                    <div class="search-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" class="form-control" placeholder="Search buyers...">
                    </div>
                    <select id="status-filter" class="form-control" style="width: 130px;">
                        <option value="all">All Statuses</option>
                        <option value="awaiting">Awaiting</option>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
            </div>
            <div id="ticket-list-container">
                </div>
        </div>

        <main class="main-content" id="main-content">
            <div class="placeholder" id="placeholder-view">
                <i class="fas fa-comments"></i>
                <p>Select a ticket from the list to start a conversation.</p>
            </div>

            <div class="chat-panel hidden" id="chat-panel">
                <div class="chat-header">
                    <h2 id="chat-header-title"></h2>
                    <div class="chat-actions">
                        <button id="complete-ticket-btn" class="btn btn-secondary">
                            <i class="fas fa-check-circle"></i> Mark as Complete
                        </button>
                    </div>
                </div>
                <div class="chat-messages"><div class="message-list-wrapper"></div></div>
                <form class="chat-reply-form" id="chat-reply-form">
                    <textarea id="chat-reply-input" class="form-control" placeholder="Type your reply..." rows="1"></textarea>
                    <button type="submit" class="btn btn-primary" title="Send Message"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </main>

        <div class="details-panel hidden" id="details-panel">
            <h3>Buyer Details</h3>
            <div id="buyer-details-content">
                </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = '/api'; // IMPORTANT: This must point to your backend.
        const POLLING_RATE = 5000;

        const state = {
            user: null,
            tickets: [],
            currentTicketId: null,
            pollingInterval: null,
            filters: { search: '', status: 'all' }
        };

        const selectors = {
            loginContainer: document.getElementById('login-container'),
            loginForm: document.getElementById('login-form'),
            loginBox: document.querySelector('.login-box'),
            loginError: document.getElementById('login-error'),
            appContainer: document.getElementById('app-container'),
            ticketListPanel: document.getElementById('ticket-list-panel'),
            mainContent: document.getElementById('main-content'),
            chatPanel: document.getElementById('chat-panel'),
            detailsPanel: document.getElementById('details-panel'),
            placeholderView: document.getElementById('placeholder-view'),
            ticketListContainer: document.getElementById('ticket-list-container'),
            searchInput: document.getElementById('search-input'),
            statusFilter: document.getElementById('status-filter'),
            chatHeaderTitle: document.getElementById('chat-header-title'),
            chatMessagesWrapper: document.querySelector('.message-list-wrapper'),
            chatReplyInput: document.getElementById('chat-reply-input'),
            chatReplyForm: document.getElementById('chat-reply-form'),
            completeBtn: document.getElementById('complete-ticket-btn'),
            buyerDetailsContent: document.getElementById('buyer-details-content'),
            notificationSound: document.getElementById('notification-sound'),
            toastContainer: document.getElementById('toast-container'),
            logoutBtn: document.getElementById('logout-btn'),
        };

        // --- UTILITY FUNCTIONS ---
        const escapeHTML = str => str ? str.toString().replace(/[&<>"']/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[tag])) : '';
        const timeAgo = (date) => {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 5) return "just now";
            let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "m ago";
            return Math.floor(seconds) + "s ago";
        };

        const showToast = (message) => {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas fa-info-circle"></i> <p>${escapeHTML(message)}</p>`;
            selectors.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.transition = 'opacity 0.3s, transform 0.3s';
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };

        // --- API & AUTHENTICATION ---
        const authFetch = async (url, options = {}) => {
            const token = localStorage.getItem('token');
            if (!token) {
                showLoginScreen();
                throw new Error('No token found.');
            }
            const headers = { 'Content-Type': 'application/json', ...options.headers, 'Authorization': `Bearer ${token}` };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('token');
                showLoginScreen();
                throw new Error('Session expired. Please log in again.');
            }
            return response;
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            selectors.loginError.textContent = '\u00A0';
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const turnstileToken = selectors.loginForm.querySelector('[name="cf-turnstile-response"]')?.value;
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, turnstileToken })
                });
                const data = await response.json();
                if (!response.ok || !['seller', 'admin'].includes(data.role)) {
                    throw new Error(data.message || 'Invalid credentials or permissions.');
                }
                localStorage.setItem('token', data.token);
                showApp();
            } catch (error) {
                selectors.loginError.textContent = error.message;
                selectors.loginBox.classList.add('shake');
                setTimeout(() => selectors.loginBox.classList.remove('shake'), 500);
            } finally {
                if (window.turnstile) window.turnstile.reset();
            }
        };

        const showApp = () => {
            const token = localStorage.getItem('token');
            if (!token) return showLoginScreen();
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                state.user = { id: payload.id, username: payload.username };
            } catch (e) { return showLoginScreen(); }
            selectors.loginContainer.style.display = 'none';
            selectors.appContainer.style.display = 'grid';
            updateData();
            state.pollingInterval = setInterval(updateData, POLLING_RATE);
        };

        const showLoginScreen = () => {
            localStorage.removeItem('token');
            if (state.pollingInterval) clearInterval(state.pollingInterval);
            state.user = null; state.tickets = []; state.currentTicketId = null;
            selectors.appContainer.style.display = 'none';
            selectors.loginContainer.style.display = 'flex';
        };
        
        // --- UI RENDERING ---
        const renderTicketList = () => {
            const filteredTickets = state.tickets
                .filter(t => {
                    const statusDef = t.claimed_by ? (t.status === 'completed' ? 'completed' : 'active') : 'awaiting';
                    const statusMatch = state.filters.status === 'all' || statusDef === state.filters.status;
                    const searchMatch = state.filters.search === '' || t.buyer_name.toLowerCase().includes(state.filters.search.toLowerCase());
                    return statusMatch && searchMatch;
                })
                .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

            selectors.ticketListContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            filteredTickets.forEach(ticket => {
                const item = document.createElement('div');
                item.className = 'ticket-item';
                item.dataset.ticketId = ticket.id;
                if (ticket.id === state.currentTicketId) item.classList.add('active');

                const statusDef = ticket.claimed_by ? (ticket.status === 'completed' ? 'completed' : 'active') : 'awaiting';

                const claimAction = statusDef === 'awaiting' 
                    ? `<div class="ticket-actions">
                         <button class="action-btn btn-claim" title="Claim Ticket"><i class="fas fa-check"></i></button>
                       </div>` 
                    : '';

                item.innerHTML = `
                    <div class="ticket-status ${statusDef}"></div>
                    <div class="ticket-details">
                        <div class="ticket-details-row1">
                            <span class="ticket-buyer">${escapeHTML(ticket.buyer_name)}</span>
                            <span class="ticket-timestamp">${timeAgo(ticket.updated_at)}</span>
                        </div>
                        <div class="ticket-payment">${escapeHTML(ticket.payment_method)}</div>
                    </div>
                    ${claimAction}
                `;
                fragment.appendChild(item);
            });
            selectors.ticketListContainer.appendChild(fragment);
        };

        const renderChatView = () => {
            const ticket = state.tickets.find(t => t.id === state.currentTicketId);
            if (!ticket) {
                selectors.appContainer.classList.remove('chat-open');
                selectors.placeholderView.classList.remove('hidden');
                selectors.chatPanel.classList.add('hidden');
                selectors.detailsPanel.classList.add('hidden');
                return;
            }

            selectors.appContainer.classList.add('chat-open');
            selectors.placeholderView.classList.add('hidden');
            selectors.chatPanel.classList.remove('hidden');
            selectors.detailsPanel.classList.remove('hidden');

            const isMyTicket = ticket.claimed_by === state.user.id;
            const statusDef = ticket.claimed_by ? (ticket.status === 'completed' ? 'completed' : 'active') : 'awaiting';
            
            selectors.chatHeaderTitle.textContent = `Chat with ${escapeHTML(ticket.buyer_name)}`;
            selectors.completeBtn.style.display = isMyTicket && statusDef !== 'completed' ? 'inline-flex' : 'none';

            const isChatLocked = statusDef === 'completed' || !isMyTicket;
            selectors.chatReplyInput.disabled = isChatLocked;
            selectors.chatReplyForm.querySelector('button').disabled = isChatLocked;
            selectors.chatReplyInput.placeholder = isChatLocked ? "This chat is locked." : "Type your reply...";
            
            selectors.chatMessagesWrapper.innerHTML = '';
            (ticket.messages || []).forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${msg.sender}`;
                bubble.innerHTML = `<p>${escapeHTML(msg.message).replace(/\n/g, '<br>')}</p>`;
                selectors.chatMessagesWrapper.appendChild(bubble);
            });

            selectors.buyerDetailsContent.innerHTML = `
                <div class="detail-item"><label>Buyer Name</label><p>${escapeHTML(ticket.buyer_name)}</p></div>
                <div class="detail-item"><label>Payment Method</label><p>${escapeHTML(ticket.payment_method)}</p></div>
                <div class="detail-item"><label>Ticket Status</label><p style="text-transform: capitalize;">${escapeHTML(statusDef)}</p></div>
                <div class="detail-item"><label>Last Update</label><p>${new Date(ticket.updated_at).toLocaleString()}</p></div>
            `;
        };

        const updateData = async () => {
            try {
                const res = await authFetch(`${API_BASE_URL}/tickets/all`);
                if (!res.ok) throw new Error("Couldn't load tickets.");
                const newTickets = await res.json();
                
                const oldTicketsMap = new Map(state.tickets.map(t => [t.id, t]));
                
                newTickets.forEach(newTicket => {
                    const oldTicket = oldTicketsMap.get(newTicket.id);
                    if (!oldTicket) {
                        showToast(`New ticket from ${newTicket.buyer_name}`);
                        selectors.notificationSound.play().catch(e => {});
                    } else if ((newTicket.messages?.length || 0) > (oldTicket.messages?.length || 0) && newTicket.last_message_sender === 'user') {
                        if (newTicket.id !== state.currentTicketId) { // Don't notify for the chat you have open
                            showToast(`New message from ${newTicket.buyer_name}`);
                            selectors.notificationSound.play().catch(e => {});
                        }
                    }
                });

                state.tickets = newTickets;
                renderTicketList();
                if (state.currentTicketId) renderChatView();

            } catch (error) { 
                console.error("Failed to update data:", error);
            }
        };

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            selectors.loginForm.addEventListener('submit', handleLogin);
            selectors.logoutBtn.addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });

            selectors.searchInput.addEventListener('input', () => {
                state.filters.search = selectors.searchInput.value;
                renderTicketList();
            });

            selectors.statusFilter.addEventListener('change', () => {
                state.filters.status = selectors.statusFilter.value;
                renderTicketList();
            });

            selectors.ticketListContainer.addEventListener('click', async e => {
                const ticketItem = e.target.closest('.ticket-item');
                const claimBtn = e.target.closest('.btn-claim');

                if (claimBtn) {
                    e.stopPropagation();
                    const ticketId = parseInt(ticketItem.dataset.ticketId);
                    claimBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    claimBtn.disabled = true;
                    try {
                        await authFetch(`${API_BASE_URL}/tickets/${ticketId}/claim`, { method: 'POST' });
                        await authFetch(`${API_BASE_URL}/tickets/${ticketId}/messages`, {
                            method: 'POST',
                            body: JSON.stringify({ message: "Hello! Your ticket has been claimed and I will be assisting you shortly." })
                        });
                        state.currentTicketId = ticketId;
                        await updateData();
                    } catch (error) {
                         console.error('Failed to claim ticket:', error);
                         claimBtn.innerHTML = '<i class="fas fa-check"></i>';
                         claimBtn.disabled = false;
                         showToast("Failed to claim ticket.");
                    }
                } else if (ticketItem) {
                    state.currentTicketId = parseInt(ticketItem.dataset.ticketId);
                    renderTicketList();
                    renderChatView();
                }
            });

            selectors.chatReplyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = selectors.chatReplyInput.value.trim();
                if (!message || !state.currentTicketId) return;
                
                selectors.chatReplyInput.disabled = true;
                try {
                    await authFetch(`${API_BASE_URL}/tickets/${state.currentTicketId}/messages`, {
                        method: 'POST', body: JSON.stringify({ message })
                    });
                    selectors.chatReplyInput.value = '';
                    await updateData();
                } catch (error) { 
                    console.error("Failed to send message", error);
                    showToast("Failed to send message.");
                } finally {
                    selectors.chatReplyInput.disabled = false;
                    selectors.chatReplyInput.focus();
                }
            });

            // Add other listeners like completeBtn here
        }

        // --- INITIALIZATION ---
        if (localStorage.getItem('token')) {
            showApp();
        } else {
            showLoginScreen();
        }
        setupEventListeners();
    });
    </script>
</body>
</html>
