<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Eps1llon Seller Hub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <style>
    :root {
      --bg-dark: #0e1218;
      --bg-light: #161b22;
      --primary: #2f81f7;
      --secondary: #ffc107;
      --text-light: #c9d1d9;
      --text-muted: #8b949e;
      --danger: #da3633;
      --success: #2ea043;
      --glass-bg: rgba(22, 27, 34, 0.75);
      --border: rgba(255,255,255,0.08);
      --radius: 14px;
      --shadow: 0 8px 32px rgba(0,0,0,0.35);
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
    body {
      display:flex; height:100vh; overflow:hidden;
      background:linear-gradient(145deg,#0d1117,#161b22);
      color:var(--text-light);
    }
    ::-webkit-scrollbar{width:7px;}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:5px;}
    ::-webkit-scrollbar-thumb:hover{background:var(--primary);}
    
    /* Login */
    #login-container {
      display:flex; align-items:center; justify-content:center; width:100%; height:100vh;
    }
    .login-box {
      background:var(--glass-bg); backdrop-filter:blur(14px);
      border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:2.5rem; text-align:center; width:100%; max-width:400px;
      animation:fadeIn .6s ease;
    }
    .login-box h2{font-size:1.8rem;font-weight:700;margin-bottom:.75rem;color:#fff;}
    .login-box p{color:var(--text-muted);margin-bottom:1.75rem;}
    .form-control {
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border);
      background:var(--bg-dark); color:var(--text-light); margin-bottom:1.2rem;
    }
    .form-control:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(47,129,247,.3);}
    .btn {
      border:none; border-radius:10px; padding:12px; font-weight:600; cursor:pointer;
      transition:all .2s ease; display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
    }
    .btn-primary{background:var(--primary);color:#fff;}
    .btn-primary:hover{background:#3f8ff7; transform:translateY(-2px);}
    #login-error{display:none;color:var(--danger);margin-top:1rem;font-weight:600;}
    
    /* App container */
    #app-container{display:none;width:100%;}
    .sidebar {
      width:250px; background:var(--bg-light); display:flex; flex-direction:column; border-right:1px solid var(--border);
    }
    .logo{padding:1.5rem;display:flex;align-items:center;gap:.75rem;}
    .logo i{font-size:1.8rem;color:var(--primary);}
    .logo h1{font-size:1.3rem;font-weight:700;color:#fff;}
    .nav-links{flex:1;overflow-y:auto;padding:0 1rem;}
    .nav-category{font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin:.75rem 0;}
    .nav-links a {
      display:flex;align-items:center;gap:.75rem;padding:.9rem 1rem;margin-bottom:.3rem;
      border-radius:10px;text-decoration:none;color:var(--text-muted);transition:all .2s;
    }
    .nav-links a:hover{background:rgba(255,255,255,.05);color:#fff;}
    .nav-links a.active{background:var(--primary);color:#fff;box-shadow:0 0 10px rgba(47,129,247,.4);}
    .logout-link{margin-top:auto;padding:1rem;}
    
    .main-content{flex:1;display:flex;flex-direction:column;padding:2rem;overflow:hidden;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;}
    header h1{font-size:1.8rem;font-weight:700;}
    
    .content-panel{display:none;flex:1;overflow:hidden;}
    .content-panel.active{display:flex;flex-direction:column;}
    
    .panel-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.25rem;}
    .panel-wrapper {
      background:var(--glass-bg);border:1px solid var(--border);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;
    }
    .panel-header{padding:1rem 1.25rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
    .panel-body{padding:1.25rem;overflow-y:auto;}
    .stat-card{text-align:center;}
    .stat-number{font-size:2.4rem;font-weight:700;color:var(--primary);}
    .stat-label{margin-top:.5rem;font-size:.95rem;color:var(--text-muted);}
    
    /* Chats */
    #chats-grid{display:grid;grid-template-columns:320px 1fr;gap:1.5rem;height:100%;}
    .chat-item {
      background:rgba(255,255,255,.02);border:1px solid transparent;margin:0 1rem .75rem;
      border-radius:10px;padding:1rem;cursor:pointer;transition:all .2s;display:flex;gap:1rem;align-items:center;position:relative;
    }
    .chat-item:hover{background:rgba(47,129,247,.1);}
    .chat-item.active{background:var(--primary);color:#fff;}
    .chat-item-icon{font-size:1.4rem;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--bg-dark);border-radius:8px;}
    .chat-user{font-weight:600;}
    .unread-badge{position:absolute;top:10px;right:10px;background:var(--secondary);color:#111;padding:3px 7px;border-radius:50%;font-size:.75rem;font-weight:700;}
    
    #chat-view{display:flex;flex-direction:column;height:100%;}
    #chat-messages{flex:1;overflow-y:auto;padding:1.25rem;display:flex;flex-direction:column;gap:1rem;}
    .message-bubble{padding:.8rem 1rem;border-radius:14px;max-width:75%;}
    .message-bubble.seller{background:var(--primary);color:#fff;align-self:flex-end;border-bottom-right-radius:4px;}
    .message-bubble.user{background:var(--bg-light);border:1px solid var(--border);align-self:flex-start;border-bottom-left-radius:4px;}
    #chat-reply-form{display:flex;gap:.75rem;padding:1rem;border-top:1px solid var(--border);}
    #chat-reply-input{flex:1;resize:none;}
    #claim-action-bar{display:none;padding:1rem;border-top:1px solid var(--border);text-align:center;}
    
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
  </style>
</head>
<body>
  <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>
  
  <div id="login-container">
    <div class="login-box">
      <h2><i class="fa-solid fa-atom"></i> Eps1llon Seller Hub</h2>
      <p>Please log in to continue.</p>
      <form id="login-form">
        <input type="text" id="username" class="form-control" placeholder="Username" required>
        <input type="password" id="password" class="form-control" placeholder="Password" required>
        <div class="cf-turnstile" data-sitekey="0x4AAAAAAB0PeEmSeY6uJ3nN" data-theme="dark" style="margin-bottom:1.5rem;"></div>
        <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
        <p id="login-error">Invalid username or password.</p>
      </form>
    </div>
  </div>
  
  <div id="app-container">
    <aside class="sidebar">
      <div class="logo"><i class="fa-solid fa-atom"></i><h1>Eps1llon</h1></div>
      <nav class="nav-links">
        <div class="nav-category">General</div>
        <a href="#" class="active" data-tab="dashboard"><i class="fas fa-chart-pie"></i> <span>Dashboard</span></a>
        <div class="nav-category">Sales</div>
        <a href="#" data-tab="chats"><i class="fas fa-comments"></i> <span>Buyer Chats</span></a>
        <div class="logout-link"><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></div>
      </nav>
    </aside>
    <main class="main-content">
      <header><h1 id="header-title">Dashboard</h1></header>
      <section class="content-panel active" id="dashboard-tab">
        <div class="panel-grid">
          <div class="panel-wrapper stat-card"><div class="panel-body"><div id="stat-awaiting" class="stat-number">0</div><div class="stat-label">Tickets Awaiting Claim</div></div></div>
          <div class="panel-wrapper stat-card"><div class="panel-body"><div id="stat-active" class="stat-number">0</div><div class="stat-label">Your Active Tickets</div></div></div>
          <div class="panel-wrapper stat-card"><div class="panel-body"><div id="stat-completed" class="stat-number">0</div><div class="stat-label">Total Completed</div></div></div>
        </div>
      </section>
      <section class="content-panel" id="chats-tab">
        <div id="chats-grid">
          <div class="panel-wrapper"><div id="chat-list-container"></div></div>
          <div class="panel-wrapper">
            <div id="chat-view" class="hidden">
              <div class="panel-header"><div><h2 id="chat-header-title"></h2><small id="chat-header-details"></small></div></div>
              <div id="chat-messages"></div>
              <form id="chat-reply-form"><textarea id="chat-reply-input" class="form-control" placeholder="Type your reply..."></textarea><button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button></form>
              <div id="claim-action-bar"><button id="claim-ticket-btn" class="btn btn-success"><i class="fas fa-check"></i> Claim Ticket</button></div>
            </div>
            <div id="chat-placeholder" style="flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;color:var(--text-muted);"><i class="fas fa-envelope-open-text" style="font-size:3rem;margin-bottom:1rem;opacity:.4;"></i><p>Select a chat to view messages.</p></div>
          </div>
        </div>
      </section>
    </main>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      const API_BASE_URL='/api';
      const POLLING_RATE=5000;
      const state={user:null,tickets:new Map(),currentTicketId:null,interval:null};
      const sel={
        login:document.getElementById('login-container'),app:document.getElementById('app-container'),
        form:document.getElementById('login-form'),error:document.getElementById('login-error'),
        chatList:document.getElementById('chat-list-container'),chatView:document.getElementById('chat-view'),
        chatPlaceholder:document.getElementById('chat-placeholder'),headerTitle:document.getElementById('header-title'),
        navLinks:document.querySelectorAll('.nav-links a'),
        statAwaiting:document.getElementById('stat-awaiting'),statActive:document.getElementById('stat-active'),statCompleted:document.getElementById('stat-completed')
      };
      const escapeHTML=str=>str.replace(/[&<>"']/g,t=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[t]));
      
      const authFetch=async(url,opt={})=>{
        const token=localStorage.getItem('token');
        const headers={'Content-Type':'application/json',...opt.headers,'Authorization':`Bearer ${token}`};
        const res=await fetch(url,{...opt,headers});
        if(res.status===401){localStorage.removeItem('token');showLogin();throw new Error('Unauthorized');}
        return res;
      };
      
      const login=async e=>{
        e.preventDefault();
        const u=document.getElementById('username').value,p=document.getElementById('password').value;
        try{
          const r=await fetch(`${API_BASE_URL}/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
          const d=await r.json();
          if(!r.ok)throw new Error(d.message||'Invalid');
          localStorage.setItem('token',d.token);
          showApp(d);
        }catch(err){sel.error.textContent=err.message;sel.error.style.display='block';}
      };
      const showApp=(data)=>{
        const payload=JSON.parse(atob(data.token.split('.')[1]));
        state.user={id:payload.id,role:payload.role};
        sel.login.style.display='none';sel.app.style.display='flex';
        update();state.interval=setInterval(update,POLLING_RATE);
      };
      const showLogin=()=>{sel.app.style.display='none';sel.login.style.display='flex';};
      
      const update=async()=>{
        const res=await authFetch(`${API_BASE_URL}/tickets/all`);
        const all=await res.json();
        // filter: only show unclaimed OR claimed by me
        const filtered=all.filter(t=>!t.claimed_by||t.claimed_by===state.user.id);
        state.tickets=new Map(filtered.map(t=>[t.id,t]));
        renderChatList();
      };
      const renderChatList=()=>{
        sel.chatList.innerHTML='';
        const arr=Array.from(state.tickets.values());
        arr.sort((a,b)=>new Date(b.updated_at)-new Date(a.updated_at));
        arr.forEach(t=>{
          const el=document.createElement('div');
          el.className=`chat-item ${state.currentTicketId===t.id?'active':''}`;
          el.dataset.id=t.id;
          el.innerHTML=`<div class="chat-item-icon"><i class="fas fa-user"></i></div><div><div class="chat-user">${escapeHTML(t.buyer_name||'Buyer')}</div><div class="chat-payment">${escapeHTML(t.payment_method||'')}</div></div>${t.unreadCount?`<div class="unread-badge">${t.unreadCount}</div>`:''}`;
          el.onclick=()=>{state.currentTicketId=t.id;renderChatView();};
          sel.chatList.appendChild(el);
        });
        sel.statAwaiting.textContent=arr.filter(x=>!x.claimed_by).length;
        sel.statActive.textContent=arr.filter(x=>x.status==='processing').length;
        sel.statCompleted.textContent=arr.filter(x=>x.status==='completed').length;
      };
      const renderChatView=()=>{
        const t=state.tickets.get(state.currentTicketId);if(!t)return;
        sel.chatPlaceholder.style.display='none';sel.chatView.classList.remove('hidden');
        document.getElementById('chat-header-title').textContent=`Chat with ${t.buyer_name}`;
        const msgs=document.getElementById('chat-messages');msgs.innerHTML='';
        (t.messages||[]).forEach(m=>{
          const div=document.createElement('div');
          div.className=`message-bubble ${m.sender}`;
          div.innerHTML=`<div style="font-size:.75rem;font-weight:600;margin-bottom:3px;">${m.sender==='user'?t.buyer_name:'You'}</div>${escapeHTML(m.message)}`;
          msgs.appendChild(div);
        });
      };
      
      sel.form.addEventListener('submit',login);
      sel.navLinks.forEach(l=>l.addEventListener('click',e=>{e.preventDefault();sel.navLinks.forEach(n=>n.classList.remove('active'));l.classList.add('active');document.querySelectorAll('.content-panel').forEach(p=>p.classList.remove('active'));document.getElementById(`${l.dataset.tab}-tab`).classList.add('active');sel.headerTitle.textContent=l.textContent.trim();}));
    });
  </script>
</body>
</html>
