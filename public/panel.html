<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eps1llon Team Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        :root {
            --font-family: 'Inter', sans-serif;
            --background-primary: #0d1117;
            --background-secondary: #161b22;
            --surface-primary: #21262d;
            --surface-hover: #30363d;
            --border-primary: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #7d8590;
            --text-emphasis: #f0f6fc;
            --accent-primary: #2f81f7;
            --accent-primary-hover: #58a6ff;
            --accent-danger: #da3633;
            --accent-success: #238636;
            --accent-warning: #d29922;
            --accent-internal: #8957e5;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            --radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-family: var(--font-family); background: var(--background-primary); color: var(--text-primary); font-size: 14px; }
        body { height: 100vh; width: 100vw; overflow: hidden; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Login Screen */
        #login-container { display: flex; align-items: center; justify-content: center; height: 100%; animation: fadeIn 0.5s ease; }
        .login-box { width: 100%; max-width: 400px; padding: 2.5rem; background: var(--background-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); }
        .login-box.shake { animation: shake 0.4s ease-in-out; }
        .login-box h2 { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-emphasis); }
        .login-box p { color: var(--text-secondary); margin-bottom: 2rem; }
        #login-error { color: var(--accent-danger); font-size: 0.9rem; margin-top: 1rem; min-height: 1.2em; }

        /* Main App Layout */
        #app-container { display: none; grid-template-columns: 240px 380px 1fr 300px; height: 100vh; width: 100vw; }
        
        /* Sidebar */
        .sidebar { background: var(--background-primary); border-right: 1px solid var(--border-primary); display: flex; flex-direction: column; padding: 1rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; margin-bottom: 1.5rem;}
        .logo i { font-size: 1.75rem; color: var(--accent-primary); }
        .logo h1 { font-size: 1.25rem; font-weight: 600; }
        .nav-category { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); padding: 1.5rem 0.5rem 0.5rem; }
        .nav-links a { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; margin-bottom: 0.25rem; font-size: 1rem; font-weight: 500; color: var(--text-secondary); text-decoration: none; border-radius: 6px; transition: color 0.2s ease, background-color 0.2s ease; }
        .nav-links a:hover { color: var(--text-emphasis); background: var(--surface-hover); }
        .nav-links a.active { color: var(--text-emphasis); background: var(--accent-primary); font-weight: 600; }
        .nav-links a i { width: 20px; text-align: center; }

        /* Ticket List Panel */
        .ticket-list-panel { display: flex; flex-direction: column; height: 100%; border-right: 1px solid var(--border-primary); background: var(--background-secondary); }
        .ticket-list-header { padding: 1rem; border-bottom: 1px solid var(--border-primary); flex-shrink: 0; }
        .ticket-list-header h1 { font-size: 1.25rem; }
        #ticket-list-container { overflow-y: auto; flex-grow: 1; }
        .ticket-item { display: flex; gap: 1rem; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-primary); cursor: pointer; position: relative; transition: background-color 0.2s ease; }
        .ticket-item:hover { background-color: var(--surface-primary); }
        .ticket-item.active { background-color: var(--accent-primary); color: white; }
        .ticket-item.active .ticket-timestamp, .ticket-item.active .ticket-payment, .ticket-item.active .ticket-buyer-name { color: rgba(255,255,255,0.9); }
        
        .assignee-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--surface-primary); color: var(--text-emphasis); display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0; }
        .assignee-avatar i { font-size: 1.2rem; color: var(--text-secondary); }

        .ticket-details { flex-grow: 1; min-width: 0; }
        .ticket-buyer-name { font-weight: 600; }
        .ticket-timestamp { font-size: 0.8rem; color: var(--text-secondary); }
        .ticket-info { display: flex; align-items: center; gap: 0.5rem; margin-top: 4px; font-size: 0.85rem; color: var(--text-secondary); }
        .payment-logo { height: 16px; filter: grayscale(100%) opacity(70%); }
        .ticket-item:hover .payment-logo, .ticket-item.active .payment-logo { filter: none; }

        /* Chat Panel */
        .chat-panel { display: flex; flex-direction: column; height: 100%; background: var(--background-secondary); }
        .chat-header { padding: 1rem; border-bottom: 1px solid var(--border-primary); flex-shrink: 0; }
        .chat-tabs { display: flex; gap: 0.25rem; border: 1px solid var(--border-primary); border-radius: 6px; padding: 0.25rem; max-width: max-content; }
        .chat-tab { padding: 0.4rem 0.8rem; border-radius: 4px; font-weight: 500; cursor: pointer; transition: 0.2s ease; }
        .chat-tab.active { background-color: var(--surface-primary); color: var(--text-emphasis); }
        
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column-reverse; }
        .message-list-wrapper { display: flex; flex-direction: column; gap: 1rem; }
        .message-bubble { max-width: 80%; padding: 0.75rem 1.25rem; line-height: 1.5; border-radius: 18px; animation: slideInUp 0.3s ease-out; word-wrap: break-word; }
        .message-bubble.seller { background: var(--accent-primary); color: white; border-bottom-right-radius: 6px; align-self: flex-end; }
        .message-bubble.user { background: var(--background-primary); border: 1px solid var(--border-primary); border-bottom-left-radius: 6px; align-self: flex-start; }
        .message-bubble.internal { background: rgba(137, 87, 229, 0.1); border: 1px solid var(--accent-internal); color: var(--text-primary); align-self: stretch; text-align: center; }

        .chat-reply-form { display: flex; gap: 1rem; align-items: flex-start; padding: 1rem; border-top: 1px solid var(--border-primary); background: var(--background-primary); }
        
        /* Details Panel */
        .details-panel { padding: 1.5rem 1rem; background: var(--background-primary); border-left: 1px solid var(--border-primary); }
        .details-panel h3 { font-size: 1.2rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-primary); padding-bottom: 0.75rem; }
        .detail-item { margin-bottom: 1.25rem; }
        .detail-item label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .detail-item p, .detail-item .form-control { font-size: 1rem; }

        /* General UI elements */
        .placeholder { display: none; flex-direction: column; height: 100%; justify-content: center; align-items: center; color: var(--text-secondary); text-align: center; background: var(--background-secondary); grid-column: 3 / -1; }
        .placeholder.visible { display: flex; }
        .placeholder i { font-size: 3rem; margin-bottom: 1rem; }
        .form-control { width: 100%; padding: 0.75rem; background: var(--background-primary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 6px; font-size: 1rem; transition: 0.2s ease; }
        .form-control:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.3); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: 500; font-size: 1rem; padding: 0.6rem 1rem; border-radius: 6px; border: 1px solid transparent; cursor: pointer; transition: 0.2s ease; }
        .btn-primary { background: var(--accent-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--accent-primary-hover); }
        .btn-secondary { background: var(--surface-primary); color: var(--text-primary); border-color: var(--border-primary); }
        .btn-secondary:hover:not(:disabled) { background: var(--surface-hover); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <audio id="notification-sound" src="http://sndup.net/hb96h" preload="auto"></audio>
    
    <div id="login-container">
        <div class="login-box">
            <h2><i class="fa-solid fa-atom"></i> Eps1llon Team Hub</h2>
            <p>Please log in to your seller account.</p>
            <form id="login-form">
                <div class="input-group" style="margin-bottom: 1.25rem;">
                    <input type="text" id="username" class="form-control" placeholder="Username" required>
                </div>
                <div class="input-group" style="margin-bottom: 1.25rem;">
                    <input type="password" id="password" class="form-control" placeholder="Password" required>
                </div>
                <div class="cf-turnstile" data-sitekey="0x4AAAAAAB0PeEmSeY6uJ3nN" data-theme="dark" style="margin-bottom: 1.5rem;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 0.75rem;">Login</button>
                <p id="login-error">&nbsp;</p>
            </form>
        </div>
    </div>

    <div id="app-container">
        <aside class="sidebar">
            <div class="logo">
                <i class="fa-solid fa-atom"></i>
                <h1>Eps1llon</h1>
            </div>
            <nav class="nav-links">
                <div class="nav-category">Queues</div>
                <a href="#" data-view="unassigned" class="active"><i class="fas fa-inbox fa-fw"></i> <span>Unassigned</span></a>
                <a href="#" data-view="my_tickets"><i class="fas fa-user-tag fa-fw"></i> <span>My Tickets</span></a>
                <a href="#" data-view="all_open"><i class="fas fa-users fa-fw"></i> <span>All Open</span></a>
                <a href="#" data-view="completed"><i class="fas fa-check-circle fa-fw"></i> <span>Completed</span></a>
            </nav>
            <div style="flex-grow: 1;"></div>
            <a href="#" id="logout-btn" class="btn btn-secondary" style="width: 100%;">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </a>
        </aside>

        <div class="ticket-list-panel">
            <div class="ticket-list-header">
                <h1 id="queue-title">Unassigned</h1>
            </div>
            <div id="ticket-list-container">
                </div>
        </div>

        <div class="placeholder visible" id="placeholder-view">
            <i class="fas fa-arrow-left"></i>
            <p>Select a ticket to begin</p>
        </div>

        <div class="chat-panel hidden" id="chat-panel">
            <div class="chat-header">
                 <div class="chat-tabs">
                    <div class="chat-tab active" data-tab="conversation">Conversation</div>
                    <div class="chat-tab" data-tab="internal">Internal Notes</div>
                </div>
            </div>
            <div class="chat-messages"><div class="message-list-wrapper"></div></div>
            <form class="chat-reply-form" id="chat-reply-form">
                <textarea id="chat-reply-input" class="form-control" placeholder="Type your reply..." rows="1"></textarea>
                <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>

        <div class="details-panel hidden" id="details-panel">
            <h3>Details</h3>
            <div id="buyer-details-content"></div>
            <button id="complete-ticket-btn" class="btn btn-secondary" style="width:100%; margin-top: 1rem;"><i class="fas fa-check-circle"></i> Mark as Complete</button>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = '/api';
        const POLLING_RATE = 5000;

        const state = {
            user: null, sellers: [], tickets: [],
            currentTicketId: null, currentView: 'unassigned', currentChatTab: 'conversation',
            pollingInterval: null
        };

        const selectors = {
            loginContainer: document.getElementById('login-container'),
            loginForm: document.getElementById('login-form'),
            loginBox: document.querySelector('.login-box'),
            loginError: document.getElementById('login-error'),
            appContainer: document.getElementById('app-container'),
            logoutBtn: document.getElementById('logout-btn'),
            navLinks: document.querySelectorAll('.nav-links a'),
            queueTitle: document.getElementById('queue-title'),
            ticketListContainer: document.getElementById('ticket-list-container'),
            placeholderView: document.getElementById('placeholder-view'),
            chatPanel: document.getElementById('chat-panel'),
            detailsPanel: document.getElementById('details-panel'),
            chatTabs: document.querySelectorAll('.chat-tab'),
            chatMessagesWrapper: document.querySelector('.message-list-wrapper'),
            chatReplyForm: document.getElementById('chat-reply-form'),
            chatReplyInput: document.getElementById('chat-reply-input'),
            buyerDetailsContent: document.getElementById('buyer-details-content'),
            completeBtn: document.getElementById('complete-ticket-btn'),
        };

        const escapeHTML = str => str ? str.toString().replace(/[&<>"']/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[tag])) : '';
        const timeAgo = (date) => {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 5) return "just now";
            let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "m ago";
            return Math.floor(seconds) + "s ago";
        };
        
        const getPaymentLogo = (method) => {
            const logoMap = { 'PayPal': 'https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg', 'Crypto': 'https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg', 'Credit Card': 'https://upload.wikimedia.org/wikipedia/commons/a/ac/Old_Visa_Logo.svg', 'CashApp': 'https://upload.wikimedia.org/wikipedia/commons/c/c5/Square_Cash_app_logo.svg' };
            return logoMap[method] || 'https://static.thenounproject.com/png/1830339-200.png';
        };

        const getAvatar = (sellerId) => {
            if (!sellerId) return '<div class="assignee-avatar"><i class="fas fa-user-slash"></i></div>';
            const seller = state.sellers.find(s => s.id === sellerId);
            if (!seller) return '<div class="assignee-avatar"><i class="fas fa-user"></i></div>';
            const initials = (seller.username[0] || '').toUpperCase();
            return `<div class="assignee-avatar" title="${seller.username}">${initials}</div>`;
        };

        const authFetch = async (url, options = {}) => {
            const token = localStorage.getItem('token');
            if (!token) { showLoginScreen(); throw new Error('No token found.'); }
            const headers = { 'Content-Type': 'application/json', ...options.headers, 'Authorization': `Bearer ${token}` };
            const response = await fetch(url, { ...options, headers });
            if ([401, 403].includes(response.status)) {
                localStorage.removeItem('token');
                showLoginScreen();
                throw new Error('Session expired.');
            }
            return response;
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            selectors.loginError.textContent = '\u00A0';
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const turnstileToken = document.querySelector('[name="cf-turnstile-response"]')?.value;
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, turnstileToken })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Login failed.');
                localStorage.setItem('token', data.token);
                showApp();
            } catch (error) {
                selectors.loginError.textContent = error.message;
                selectors.loginBox.classList.add('shake');
                setTimeout(() => selectors.loginBox.classList.remove('shake'), 500);
            } finally {
                if (window.turnstile) window.turnstile.reset();
            }
        };

        const showApp = async () => {
            const token = localStorage.getItem('token');
            if (!token) return showLoginScreen();
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                state.user = { id: payload.id, username: payload.username };
                
                // In a real app, fetch sellers from an API
                const sellersRes = await authFetch(`${API_BASE_URL}/sellers`);
                state.sellers = await sellersRes.json();

            } catch (e) { console.error(e); return showLoginScreen(); }
            
            selectors.loginContainer.style.display = 'none';
            selectors.appContainer.style.display = 'grid';
            
            await updateData();
            state.pollingInterval = setInterval(updateData, POLLING_RATE);
        };

        const showLoginScreen = () => {
            localStorage.removeItem('token');
            if (state.pollingInterval) clearInterval(state.pollingInterval);
            state.user = null;
            selectors.appContainer.style.display = 'none';
            selectors.loginContainer.style.display = 'flex';
        };

        const renderTicketList = () => {
            let ticketsToDisplay = [];
            switch(state.currentView) {
                case 'unassigned': ticketsToDisplay = state.tickets.filter(t => !t.claimed_by && t.status !== 'completed'); break;
                case 'my_tickets': ticketsToDisplay = state.tickets.filter(t => t.claimed_by === state.user.id && t.status !== 'completed'); break;
                case 'all_open': ticketsToDisplay = state.tickets.filter(t => t.claimed_by && t.status !== 'completed'); break;
                case 'completed': ticketsToDisplay = state.tickets.filter(t => t.status === 'completed'); break;
            }
            ticketsToDisplay.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

            selectors.ticketListContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            ticketsToDisplay.forEach(ticket => {
                const item = document.createElement('div');
                item.className = 'ticket-item';
                item.dataset.ticketId = ticket.id;
                if (ticket.id === state.currentTicketId) item.classList.add('active');
                item.innerHTML = `
                    ${getAvatar(ticket.claimed_by)}
                    <div class="ticket-details">
                        <div style="display: flex; justify-content: space-between;">
                           <span class="ticket-buyer-name">${escapeHTML(ticket.buyer_name)}</span>
                           <span class="ticket-timestamp">${timeAgo(ticket.updated_at)}</span>
                        </div>
                        <div class="ticket-info">
                           <img src="${getPaymentLogo(ticket.payment_method)}" class="payment-logo" alt="${ticket.payment_method}">
                           <span>${escapeHTML(ticket.payment_method)}</span>
                        </div>
                    </div>`;
                fragment.appendChild(item);
            });
            selectors.ticketListContainer.appendChild(fragment);
        };
        
        const renderChatView = () => {
             const ticket = state.tickets.find(t => t.id === state.currentTicketId);
             if (!ticket) {
                selectors.placeholderView.classList.add('visible');
                selectors.chatPanel.classList.add('hidden');
                selectors.detailsPanel.classList.add('hidden');
                return;
             }
            selectors.placeholderView.classList.remove('visible');
            selectors.chatPanel.classList.remove('hidden');
            selectors.detailsPanel.classList.remove('hidden');

            const sellerOptions = state.sellers.map(s => `<option value="${s.id}" ${ticket.claimed_by === s.id ? 'selected' : ''}>${s.username}</option>`).join('');
            selectors.buyerDetailsContent.innerHTML = `
                <div class="detail-item"><label>Buyer</label><p>${escapeHTML(ticket.buyer_name)}</p></div>
                <div class="detail-item">
                    <label>Assignee</label>
                    <select class="form-control" id="assignee-select" data-ticket-id="${ticket.id}">
                        <option value="">Unassigned</option>
                        ${sellerOptions}
                    </select>
                </div>`;
            document.getElementById('assignee-select').addEventListener('change', handleReassign);
        };

        const handleReassign = async (e) => {
            const newAssigneeId = e.target.value ? parseInt(e.target.value) : null;
            const ticketId = parseInt(e.target.dataset.ticketId);
            try {
                await authFetch(`${API_BASE_URL}/tickets/${ticketId}/assign`, {
                    method: 'POST',
                    body: JSON.stringify({ sellerId: newAssigneeId })
                });
                await updateData();
            } catch (error) { console.error('Failed to reassign:', error); }
        };

        const updateData = async () => {
            try {
                const res = await authFetch(`${API_BASE_URL}/tickets/all`);
                state.tickets = await res.json();
                renderTicketList();
                if(state.currentTicketId) renderChatView();
            } catch(e) { console.error("Update failed:", e); }
        };

        function setupEventListeners() {
            selectors.loginForm?.addEventListener('submit', handleLogin);
            selectors.logoutBtn.addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });

            selectors.navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    state.currentView = link.dataset.view;
                    selectors.navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    selectors.queueTitle.textContent = link.querySelector('span').textContent;
                    renderTicketList();
                });
            });

            selectors.ticketListContainer.addEventListener('click', async e => {
                const ticketItem = e.target.closest('.ticket-item');
                if (ticketItem) {
                    const ticketId = parseInt(ticketItem.dataset.ticketId);
                    state.currentTicketId = ticketId;
                    const ticket = state.tickets.find(t => t.id === ticketId);
                    if (!ticket.claimed_by) {
                        try {
                            await authFetch(`${API_BASE_URL}/tickets/${ticketId}/claim`, { method: 'POST' });
                            await updateData(); // Refresh data to show correct assignment
                        } catch (err) { console.error("Failed to auto-claim:", err); }
                    } else {
                        renderTicketList(); // Just highlight the new selection
                        renderChatView();
                    }
                }
            });
        }
        
        // --- INITIALIZATION ---
        if (localStorage.getItem('token')) {
            showApp();
        } else {
            showLoginScreen();
        }
        setupEventListeners();
    });
    </script>
</body>
</html>
