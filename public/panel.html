<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eps1llon Team Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        :root {
            --font-family: 'Inter', sans-serif;
            --background-primary: #0d1117;
            --background-secondary: #161b22;
            --surface-primary: #21262d;
            --surface-hover: #30363d;
            --border-primary: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #7d8590;
            --text-emphasis: #f0f6fc;
            --accent-primary: #2f81f7;
            --accent-primary-hover: #58a6ff;
            --accent-danger: #da3633;
            --accent-success: #238636;
            --accent-warning: #d29922;
            --accent-internal: #8957e5;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            --radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-family: var(--font-family); background: var(--background-primary); color: var(--text-primary); font-size: 14px; }
        body { height: 100vh; width: 100vw; overflow: hidden; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Login Screen */
        #login-container { display: flex; align-items: center; justify-content: center; height: 100%; animation: fadeIn 0.5s ease; }
        .login-box { width: 100%; max-width: 400px; padding: 2.5rem; background: var(--background-secondary); border: 1px solid var(--border-primary); border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); }
        .login-box.shake { animation: shake 0.4s ease-in-out; }
        .login-box h2 { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-emphasis); }
        .login-box p { color: var(--text-secondary); margin-bottom: 2rem; }
        #login-error { color: var(--accent-danger); font-size: 0.9rem; margin-top: 1rem; min-height: 1.2em; }

        /* Main App Layout */
        #app-container { display: none; grid-template-columns: 240px 380px 1fr 300px; height: 100vh; width: 100vw; }
        
        /* Sidebar */
        .sidebar { background: var(--background-primary); border-right: 1px solid var(--border-primary); display: flex; flex-direction: column; padding: 1rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; margin-bottom: 1.5rem;}
        .logo i { font-size: 1.75rem; color: var(--accent-primary); }
        .logo h1 { font-size: 1.25rem; font-weight: 600; }
        .nav-category { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); padding: 1.5rem 0.5rem 0.5rem; }
        .nav-links a { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; margin-bottom: 0.25rem; font-size: 1rem; font-weight: 500; color: var(--text-secondary); text-decoration: none; border-radius: 6px; transition: color 0.2s ease, background-color 0.2s ease; }
        .nav-links a:hover { color: var(--text-emphasis); background: var(--surface-hover); }
        .nav-links a.active { color: var(--text-emphasis); background: var(--accent-primary); font-weight: 600; }
        .nav-links a i { width: 20px; text-align: center; }

        /* Ticket List Panel */
        .ticket-list-panel { display: flex; flex-direction: column; height: 100%; border-right: 1px solid var(--border-primary); background: var(--background-secondary); }
        .ticket-list-header { padding: 1rem; border-bottom: 1px solid var(--border-primary); flex-shrink: 0; }
        .ticket-list-header h1 { font-size: 1.25rem; }
        #ticket-list-container { overflow-y: auto; flex-grow: 1; }
        .ticket-item { display: flex; gap: 1rem; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-primary); cursor: pointer; position: relative; transition: background-color 0.2s ease; }
        .ticket-item:hover { background-color: var(--surface-primary); }
        .ticket-item.active { background-color: var(--accent-primary); color: white; }
        .ticket-item.active .ticket-timestamp, .ticket-item.active .ticket-payment, .ticket-item.active .ticket-buyer-name { color: rgba(255,255,255,0.9); }
        
        .assignee-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--surface-primary); color: var(--text-emphasis); display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0; }
        .assignee-avatar i { font-size: 1.2rem; color: var(--text-secondary); }

        .ticket-details { flex-grow: 1; min-width: 0; }
        .ticket-buyer-name { font-weight: 600; }
        .ticket-timestamp { font-size: 0.8rem; color: var(--text-secondary); }
        .ticket-info { display: flex; align-items: center; gap: 0.5rem; margin-top: 4px; font-size: 0.85rem; color: var(--text-secondary); }
        .payment-logo { height: 16px; }

        /* Chat Panel */
        .chat-panel { display: flex; flex-direction: column; height: 100%; background: var(--background-secondary); }
        .chat-header { padding: 1rem; border-bottom: 1px solid var(--border-primary); flex-shrink: 0; }
        .chat-tabs { display: flex; gap: 0.25rem; border: 1px solid var(--border-primary); border-radius: 6px; padding: 0.25rem; max-width: max-content; }
        .chat-tab { padding: 0.4rem 0.8rem; border-radius: 4px; font-weight: 500; cursor: pointer; transition: 0.2s ease; }
        .chat-tab.active { background-color: var(--surface-primary); color: var(--text-emphasis); }
        
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column-reverse; }
        .message-list-wrapper { display: flex; flex-direction: column; gap: 1rem; }
        .message-bubble { max-width: 80%; padding: 0.75rem 1.25rem; line-height: 1.5; border-radius: 18px; animation: slideInUp 0.3s ease-out; word-wrap: break-word; }
        .message-bubble.seller { background: var(--accent-primary); color: white; border-bottom-right-radius: 6px; align-self: flex-end; }
        .message-bubble.user { background: var(--background-primary); border: 1px solid var(--border-primary); border-bottom-left-radius: 6px; align-self: flex-start; }
        .message-bubble.internal { background: rgba(137, 87, 229, 0.1); border: 1px solid var(--accent-internal); color: var(--text-primary); align-self: stretch; text-align: center; }

        .chat-reply-form { display: flex; gap: 1rem; align-items: flex-start; padding: 1rem; border-top: 1px solid var(--border-primary); background: var(--background-primary); }
        
        /* Details Panel */
        .details-panel { padding: 1.5rem 1rem; background: var(--background-primary); border-left: 1px solid var(--border-primary); }
        .details-panel h3 { font-size: 1.2rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-primary); padding-bottom: 0.75rem; }
        .detail-item { margin-bottom: 1.25rem; }
        .detail-item label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .detail-item p, .detail-item .form-control { font-size: 1rem; }

        /* General UI elements */
        .placeholder { display: flex; flex-direction: column; height: 100%; justify-content: center; align-items: center; color: var(--text-secondary); text-align: center; background: var(--background-secondary); grid-column: 2 / -1; }
        .placeholder i { font-size: 3rem; margin-bottom: 1rem; }
        .form-control { width: 100%; padding: 0.75rem; background: var(--background-primary); color: var(--text-primary); border: 1px solid var(--border-primary); border-radius: 6px; font-size: 1rem; transition: 0.2s ease; }
        .form-control:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(47, 129, 247, 0.3); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: 500; font-size: 1rem; padding: 0.6rem 1rem; border-radius: 6px; border: 1px solid transparent; cursor: pointer; transition: 0.2s ease; }
        .btn-primary { background: var(--accent-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--accent-primary-hover); }
        .btn-secondary { background: var(--surface-primary); color: var(--text-primary); border-color: var(--border-primary); }
        .btn-secondary:hover:not(:disabled) { background: var(--surface-hover); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <audio id="notification-sound" src="http://sndup.net/hb96h" preload="auto"></audio>
    
    <div id="login-container">
        </div>

    <div id="app-container">
        <aside class="sidebar">
            <div class="logo">
                <i class="fa-solid fa-atom"></i>
                <h1>Eps1llon</h1>
            </div>
            <nav class="nav-links">
                <div class="nav-category">Queues</div>
                <a href="#" data-view="unassigned" class="active"><i class="fas fa-inbox fa-fw"></i> <span>Unassigned</span></a>
                <a href="#" data-view="my_tickets"><i class="fas fa-user-tag fa-fw"></i> <span>My Tickets</span></a>
                <a href="#" data-view="all_open"><i class="fas fa-users fa-fw"></i> <span>All Open</span></a>
                <a href="#" data-view="completed"><i class="fas fa-check-circle fa-fw"></i> <span>Completed</span></a>
            </nav>
            <div style="flex-grow: 1;"></div>
            <a href="#" id="logout-btn" class="btn btn-secondary" style="width: 100%;">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </a>
        </aside>

        <div class="ticket-list-panel">
            <div class="ticket-list-header">
                <h1 id="queue-title">Unassigned</h1>
            </div>
            <div id="ticket-list-container">
                </div>
        </div>

        <div class="placeholder" id="placeholder-view">
            <i class="fas fa-arrow-left"></i>
            <p>Select a ticket to begin</p>
        </div>

        <div class="chat-panel hidden" id="chat-panel">
            <div class="chat-header">
                 <div class="chat-tabs">
                    <div class="chat-tab active" data-tab="conversation">Conversation</div>
                    <div class="chat-tab" data-tab="internal">Internal Notes</div>
                </div>
            </div>
            <div class="chat-messages"><div class="message-list-wrapper"></div></div>
            <form class="chat-reply-form" id="chat-reply-form">
                <textarea id="chat-reply-input" class="form-control" placeholder="Type your reply..." rows="1"></textarea>
                <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>

        <div class="details-panel hidden" id="details-panel">
            <h3>Details</h3>
            <div id="buyer-details-content"></div>
            <button id="complete-ticket-btn" class="btn btn-secondary" style="width:100%; margin-top: 1rem;"><i class="fas fa-check-circle"></i> Mark as Complete</button>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = '/api'; // This must point to your backend.
        const POLLING_RATE = 5000;

        const state = {
            user: null,
            sellers: [], // Will store all sellers for reassignment
            tickets: [],
            currentTicketId: null,
            currentView: 'unassigned', // unassigned, my_tickets, all_open, completed
            currentChatTab: 'conversation', // conversation, internal
            pollingInterval: null
        };

        const selectors = {
            loginContainer: document.getElementById('login-container'),
            appContainer: document.getElementById('app-container'),
            logoutBtn: document.getElementById('logout-btn'),
            navLinks: document.querySelectorAll('.nav-links a'),
            queueTitle: document.getElementById('queue-title'),
            ticketListContainer: document.getElementById('ticket-list-container'),
            placeholderView: document.getElementById('placeholder-view'),
            chatPanel: document.getElementById('chat-panel'),
            detailsPanel: document.getElementById('details-panel'),
            chatTabs: document.querySelectorAll('.chat-tab'),
            chatMessagesWrapper: document.querySelector('.message-list-wrapper'),
            chatReplyForm: document.getElementById('chat-reply-form'),
            chatReplyInput: document.getElementById('chat-reply-input'),
            buyerDetailsContent: document.getElementById('buyer-details-content'),
            completeBtn: document.getElementById('complete-ticket-btn'),
        };

        // --- UTILITY & HELPER FUNCTIONS ---
        const escapeHTML = str => str ? str.toString().replace(/[&<>"']/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[tag])) : '';
        const timeAgo = (date) => { /* ... (same as previous) ... */ };
        
        const getPaymentLogo = (method) => {
            const logoMap = {
                'PayPal': 'https://www.paypalobjects.com/webstatic/mktg/Logo/pp-logo-100px.png',
                'Crypto': 'https://cdn4.iconfinder.com/data/icons/crypto-currency-and-coin-2/256/bch_bitcoin_cash_crypto_currency_coin-512.png',
                'Credit Card': 'https://cdn.icon-icons.com/icons2/2235/PNG/512/credit_card_payment_money_icon_134780.png',
                'CashApp': 'https://cdn.icon-icons.com/icons2/3245/PNG/512/cash_app_logo_icon_197825.png'
            };
            const defaultLogo = 'https://cdn-icons-png.flaticon.com/512/1086/1086741.png';
            return logoMap[method] || defaultLogo;
        };

        const getAvatar = (sellerId) => {
            if (!sellerId) {
                return '<div class="assignee-avatar"><i class="fas fa-user-slash"></i></div>';
            }
            const seller = state.sellers.find(s => s.id === sellerId);
            if (!seller) {
                return '<div class="assignee-avatar"><i class="fas fa-user"></i></div>';
            }
            const initials = (seller.username[0] || '').toUpperCase();
            // In a real app, you'd have different colors per user
            return `<div class="assignee-avatar" style="background-color: var(--accent-internal);">${initials}</div>`;
        };

        // --- API & AUTHENTICATION ---
        const authFetch = async (url, options = {}) => { /* ... (same as previous) ... */ };
        const showLoginScreen = () => { /* ... (same as previous) ... */ };
        const showApp = async () => {
            const token = localStorage.getItem('token');
            if (!token) return showLoginScreen();
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                state.user = { id: payload.id, username: payload.username };
                
                // MOCK SELLERS - in a real app, this would be an API call
                state.sellers = [
                    {id: 1, username: 'Alice'}, {id: 2, username: 'Bob'}, {id: 3, username: 'Charlie'}
                ];

            } catch (e) { return showLoginScreen(); }
            
            selectors.loginContainer.classList.add('hidden');
            selectors.appContainer.style.display = 'grid';
            
            await updateData();
            state.pollingInterval = setInterval(updateData, POLLING_RATE);
        };

        // --- UI RENDERING ---
        const renderTicketList = () => {
            let ticketsToDisplay = [];
            switch(state.currentView) {
                case 'unassigned':
                    ticketsToDisplay = state.tickets.filter(t => !t.claimed_by && t.status !== 'completed');
                    break;
                case 'my_tickets':
                    ticketsToDisplay = state.tickets.filter(t => t.claimed_by === state.user.id && t.status !== 'completed');
                    break;
                case 'all_open':
                    ticketsToDisplay = state.tickets.filter(t => t.claimed_by && t.status !== 'completed');
                    break;
                case 'completed':
                    ticketsToDisplay = state.tickets.filter(t => t.status === 'completed');
                    break;
            }

            ticketsToDisplay.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

            selectors.ticketListContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            ticketsToDisplay.forEach(ticket => {
                const item = document.createElement('div');
                item.className = 'ticket-item';
                item.dataset.ticketId = ticket.id;
                if (ticket.id === state.currentTicketId) item.classList.add('active');

                item.innerHTML = `
                    ${getAvatar(ticket.claimed_by)}
                    <div class="ticket-details">
                        <div style="display: flex; justify-content: space-between;">
                           <span class="ticket-buyer-name">${escapeHTML(ticket.buyer_name)}</span>
                           <span class="ticket-timestamp">${timeAgo(ticket.updated_at)}</span>
                        </div>
                        <div class="ticket-info">
                           <img src="${getPaymentLogo(ticket.payment_method)}" class="payment-logo" alt="${ticket.payment_method}">
                           <span>${escapeHTML(ticket.payment_method)}</span>
                        </div>
                    </div>
                `;
                fragment.appendChild(item);
            });
            selectors.ticketListContainer.appendChild(fragment);
        };
        
        const renderChatView = () => {
             const ticket = state.tickets.find(t => t.id === state.currentTicketId);
             if (!ticket) {
                selectors.placeholderView.classList.remove('hidden');
                selectors.chatPanel.classList.add('hidden');
                selectors.detailsPanel.classList.add('hidden');
                return;
             }
             
            selectors.placeholderView.classList.add('hidden');
            selectors.chatPanel.classList.remove('hidden');
            selectors.detailsPanel.classList.remove('hidden');
            
            // Render Messages or Internal Notes based on current tab
            selectors.chatMessagesWrapper.innerHTML = '';
            let messagesToRender = [];
            if(state.currentChatTab === 'conversation') {
                messagesToRender = ticket.messages || [];
            } else {
                // messagesToRender = ticket.internal_notes || []; // In a real app
                messagesToRender = [{sender: 'internal', message: `Note from Bob: Check payment processor for transaction ID.`}];
            }
            messagesToRender.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${msg.sender}`;
                bubble.innerHTML = `<p>${escapeHTML(msg.message).replace(/\n/g, '<br>')}</p>`;
                selectors.chatMessagesWrapper.appendChild(bubble);
            });


            // Render Details Panel
            const sellerOptions = state.sellers.map(s => `<option value="${s.id}" ${ticket.claimed_by === s.id ? 'selected' : ''}>${s.username}</option>`).join('');
            selectors.buyerDetailsContent.innerHTML = `
                <div class="detail-item"><label>Buyer</label><p>${escapeHTML(ticket.buyer_name)}</p></div>
                <div class="detail-item">
                    <label>Assignee</label>
                    <select class="form-control" id="assignee-select">
                        <option value="">Unassigned</option>
                        ${sellerOptions}
                    </select>
                </div>
            `;
        };

        const updateData = async () => {
             try {
                // In a real app, this would be a single API call
                // For demo, we create mock data
                if (state.tickets.length === 0) {
                     state.tickets = [
                        { id: 1, buyer_name: 'Alice Johnson', payment_method: 'PayPal', status: 'active', claimed_by: 1, messages: [{sender:'user', message:'Hello?'}], updated_at: new Date(Date.now() - 2 * 60000).toISOString()},
                        { id: 2, buyer_name: 'Bob Williams', payment_method: 'Crypto', status: 'open', claimed_by: null, messages: [{sender:'user', message:'Help me!'}], updated_at: new Date(Date.now() - 5 * 60000).toISOString()},
                        { id: 3, buyer_name: 'Charlie Brown', payment_method: 'Credit Card', status: 'completed', claimed_by: 2, messages: [], updated_at: new Date(Date.now() - 60 * 60000).toISOString()},
                     ];
                }
                renderTicketList();
                if(state.currentTicketId) renderChatView();
             } catch(e) { console.error(e) }
        };

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            selectors.navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    state.currentView = link.dataset.view;
                    selectors.navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    selectors.queueTitle.textContent = link.querySelector('span').textContent;
                    renderTicketList();
                });
            });

            selectors.ticketListContainer.addEventListener('click', e => {
                const ticketItem = e.target.closest('.ticket-item');
                if (ticketItem) {
                    state.currentTicketId = parseInt(ticketItem.dataset.ticketId);
                    // Automatically claim if unassigned and I click it
                    const ticket = state.tickets.find(t => t.id === state.currentTicketId);
                    if (!ticket.claimed_by) {
                        ticket.claimed_by = state.user.id;
                        ticket.status = 'active';
                    }
                    renderTicketList();
                    renderChatView();
                }
            });

            selectors.chatTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    state.currentChatTab = tab.dataset.tab;
                    selectors.chatTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderChatView(); // Re-render messages
                })
            });
        }
        
        // --- INITIALIZATION ---
        // For this demo, we'll bypass login and go straight to the app
        showApp();
        setupEventListeners();

        // You would uncomment this for a real login flow
        // if (localStorage.getItem('token')) {
        //     showApp();
        // } else {
        //     showLoginScreen();
        // }
    });
    </script>
</body>
</html>
